<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trons Games</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Handlee&display=swap');

        body {
            font-family: 'Handlee', cursive;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        nav {
            background-color: #1e293b;
            border-bottom: 2px solid #334155;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            flex-shrink: 0;
            height: 50px;
        }

        .nav-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            font-size: 0.9rem;
        }

        .nav-btn.active {
            background-color: #4f46e5;
            color: white;
        }

        .nav-btn:not(.active):hover {
            background-color: #334155;
        }

        .game-viewport {
            flex-grow: 1;
            position: relative;
            display: flex;
            width: 100%;
            height: calc(100vh - 50px);
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Cootie Catcher UI - Scaled for better fit */
        .scene { 
            perspective: 1000px; 
            width: 240px; 
            height: 240px; 
            position: relative;
            flex-shrink: 0;
            margin: 0.5rem 0;
        }
        .catcher { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.5s ease; }
        .flap {
            position: absolute; width: 120px; height: 120px; background: #1e293b; border: 2px solid #334155;
            transform-origin: center; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), background 0.3s;
            user-select: none; box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
        }
        .top-left { top: 0; left: 0; border-radius: 10px 0 0 0; }
        .top-right { top: 0; left: 120px; border-radius: 0 10px 0 0; }
        .bottom-left { top: 120px; left: 0; border-radius: 0 0 0 10px; }
        .bottom-right { top: 120px; left: 120px; border-radius: 0 0 10px 0; }
        
        .catcher.open-h .top-left { transform: rotateY(-40deg) translateX(-10px); }
        .catcher.open-h .top-right { transform: rotateY(40deg) translateX(10px); }
        .catcher.open-h .bottom-left { transform: rotateY(-40deg) translateX(-10px); }
        .catcher.open-h .bottom-right { transform: rotateY(40deg) translateX(10px); }
        .catcher.open-v .top-left { transform: rotateX(40deg) translateY(-10px); }
        .catcher.open-v .top-right { transform: rotateX(40deg) translateY(-10px); }
        .catcher.open-v .bottom-left { transform: rotateX(-40deg) translateY(10px); }
        .catcher.open-v .bottom-right { transform: rotateX(-40deg) translateY(10px); }

        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #1e293b; padding: 1.5rem; border-radius: 1.5rem; max-width: 95%;
            width: 500px; border: 2px solid #334155; max-height: 85vh; overflow-y: auto;
        }

        .hidden-fortune {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #1e293b; padding: 1.5rem; border-radius: 1rem; z-index: 100; max-width: 90%;
            width: 350px; border: 4px dashed #818cf8; text-align: center;
            max-height: 90%; overflow-y: auto;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .dot-pulse { animation: dotPulse 1.5s infinite linear; }
        @keyframes dotPulse { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }
        .hidden { display: none !important; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>

    <nav>
        <div class="flex items-center gap-2">
            <span class="text-lg font-bold text-indigo-400 mr-2 hidden sm:inline">Trons Games</span>
            <div id="nav-tabs" class="flex gap-1"></div>
        </div>
        <div id="user-status" class="text-[10px] text-slate-500 uppercase tracking-tighter">Initializing...</div>
    </nav>

    <div id="game-viewport" class="game-viewport"></div>

    <!-- Customization Modal -->
    <div id="customize-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-indigo-400 mb-4">Customize Game</h2>
            
            <div class="mb-6">
                <label class="block text-xs font-bold uppercase text-slate-400 mb-3 tracking-widest">Fortune Samples</label>
                <div id="fortune-presets" class="grid grid-cols-2 gap-2 mb-4"></div>
                
                <label class="block text-xs font-bold uppercase text-slate-400 mb-2 tracking-widest">Edit Fortunes</label>
                <div id="fortune-inputs" class="grid grid-cols-1 gap-2 max-h-40 overflow-y-auto pr-2 mb-4 border-y border-slate-700 py-2"></div>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold uppercase text-slate-400 mb-3 tracking-widest">Theme Colors</label>
                <div id="theme-presets" class="grid grid-cols-3 gap-2 mb-4"></div>
                <div class="grid grid-cols-4 gap-2">
                    <input type="color" id="color-tl" class="w-full h-8 rounded bg-slate-800 border-none cursor-pointer">
                    <input type="color" id="color-tr" class="w-full h-8 rounded bg-slate-800 border-none cursor-pointer">
                    <input type="color" id="color-bl" class="w-full h-8 rounded bg-slate-800 border-none cursor-pointer">
                    <input type="color" id="color-br" class="w-full h-8 rounded bg-slate-800 border-none cursor-pointer">
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="saveSettingsToCloud()" id="save-btn" class="flex-grow bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition text-sm">Save Everything âœ¨</button>
                <button onclick="toggleCustomize(false)" class="bg-slate-700 hover:bg-slate-600 text-slate-200 py-2 px-4 rounded-lg transition text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Cootie Catcher Template -->
    <template id="cootie-template">
        <div class="game-container">
            <div class="text-center">
                <h1 class="text-xl font-bold text-indigo-400">Cootie Catcher</h1>
                <p id="instruction" class="text-xs text-indigo-300 font-medium">Pick a Color!</p>
            </div>
            
            <div class="scene">
                <div id="catcher" class="catcher">
                    <div class="flap top-left" onclick="handleChoice('tl')"><div id="content-tl" class="w-full h-full flex items-center justify-center font-bold text-sm text-center p-1"></div></div>
                    <div class="flap top-right" onclick="handleChoice('tr')"><div id="content-tr" class="w-full h-full flex items-center justify-center font-bold text-sm text-center p-1"></div></div>
                    <div class="flap bottom-left" onclick="handleChoice('bl')"><div id="content-bl" class="w-full h-full flex items-center justify-center font-bold text-sm text-center p-1"></div></div>
                    <div class="flap bottom-right" onclick="handleChoice('br')"><div id="content-br" class="w-full h-full flex items-center justify-center font-bold text-sm text-center p-1"></div></div>
                </div>
            </div>

            <div id="fortune-modal" class="hidden-fortune shadow-2xl">
                <h2 class="text-lg font-bold text-indigo-300 mb-1">Your Fortune:</h2>
                <div id="loading-spinner" class="mb-3 hidden">
                    <div class="flex justify-center gap-2">
                        <div class="w-2 h-2 bg-indigo-400 rounded-full dot-pulse"></div>
                        <div class="w-2 h-2 bg-indigo-400 rounded-full dot-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-indigo-400 rounded-full dot-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
                <p id="fortune-text" class="text-base italic text-slate-100 mb-4"></p>
                <div id="charm-container" class="hidden mb-4 flex flex-col items-center">
                    <img id="charm-image" class="w-24 h-24 rounded-lg shadow-inner border-2 border-indigo-500/30 mb-2" src="" alt="Charm">
                </div>
                <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                        <button id="tts-btn" onclick="speakFortune()" class="flex-1 bg-indigo-900/50 text-indigo-200 border border-indigo-500/50 px-2 py-1.5 rounded-full text-[10px] hidden">Hear âœ¨</button>
                        <button id="image-btn" onclick="generateCharm()" class="flex-1 bg-indigo-900/50 text-indigo-200 border border-indigo-500/50 px-2 py-1.5 rounded-full text-[10px] hidden">Charm âœ¨</button>
                    </div>
                    <button onclick="resetGame()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-full hover:bg-indigo-500 transition text-sm">Play Again</button>
                </div>
            </div>

            <div class="h-6 mb-1"><div id="counter" class="text-xl font-bold text-indigo-400"></div></div>
            
            <div class="flex flex-col gap-2 w-full max-w-[240px] mb-4">
                <button onclick="toggleCustomize(true)" class="flex items-center justify-center gap-2 bg-indigo-900/40 text-indigo-200 border border-indigo-500/30 px-3 py-1.5 rounded-full hover:bg-indigo-800 transition text-[10px]">
                    Customize Game ðŸŽ¨
                </button>
                <div class="flex items-center justify-between bg-slate-800 px-3 py-1 rounded-full shadow-md border border-slate-700">
                    <span class="text-indigo-300 font-medium text-[10px]">AI Mode</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="gemini-toggle" class="sr-only peer" checked>
                        <div class="w-7 h-3.5 bg-slate-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-indigo-500"></div>
                    </label>
                </div>
                <div id="vibe-selector" class="flex items-center justify-between bg-slate-800 px-3 py-1 rounded-full shadow-md border border-slate-700">
                    <span class="text-indigo-300 font-medium text-[10px]">AI Vibe âœ¨</span>
                    <select id="fortune-vibe" class="bg-transparent text-indigo-200 text-[10px] focus:outline-none">
                        <option value="heroic">Heroic</option>
                        <option value="spooky">Spooky</option>
                        <option value="funny">Funny</option>
                        <option value="mystical" selected>Mystical</option>
                    </select>
                </div>
            </div>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Safe Firebase Config check for GitHub Pages
        let db, auth, user;
        let isLocalMode = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; 

        try {
            if (typeof __firebase_config === 'undefined') throw new Error("No config");
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            isLocalMode = true;
            document.getElementById('user-status').innerText = "Local Mode (No Sync)";
        }

        const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const IMAGE_MODEL = "imagen-4.0-generate-001";

        const themePresets = [
            { id: 'classic', name: 'Classic', colors: ['#991b1b', '#1e3a8a', '#064e3b', '#713f12'] },
            { id: 'cyber', name: 'Cyber', colors: ['#ec4899', '#06b6d4', '#84cc16', '#a855f7'] },
            { id: 'nature', name: 'Nature', colors: ['#14532d', '#1e3a8a', '#365314', '#164e63'] }
        ];

        const fortuneSamples = [
            { name: 'Standard', list: ["Lucky penny day!", "Adventure awaits!", "New friend soon!", "Surprise coming!", "Kindness rewarded!", "Secret admirer!", "Success ahead!", "Famous explorer!"] },
            { name: 'School Jokes', list: ["Why math book sad? Too many problems.", "Plate to plate? Dinner is on me!", "How to make tissue dance? Boogey!", "Cat color? Purrr-ple.", "Pencil vacation? Pencil-vania.", "Trust atoms? They make up everything.", "Falls but never hurt? Snow.", "Teacher shades? Bright students!"] },
            { name: 'Encouraging', list: ["You are smart!", "You can do it!", "Believe in yourself.", "Make it great.", "You are helpful.", "Try your best.", "Mistakes help us learn.", "You are a friend."] }
        ];

        let activeTheme = [...themePresets[0].colors];
        let activeFortunes = [...fortuneSamples[0].list];

        const games = [
            { id: 'wordle', title: 'Wordle', type: 'iframe', url: 'https://tronsguitar.github.io/Wordle-Clone/' },
            { id: 'cootie', title: 'Cootie Catcher', type: 'internal' }
        ];

        window.setupApp = function() {
            const tabsContainer = document.getElementById('nav-tabs');
            const viewport = document.getElementById('game-viewport');
            const themeContainer = document.getElementById('theme-presets');
            const sampleContainer = document.getElementById('fortune-presets');
            const inputContainer = document.getElementById('fortune-inputs');

            themePresets.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "flex flex-col items-center gap-1 bg-slate-800 p-1.5 rounded border border-slate-700 hover:border-indigo-500 transition text-[10px]";
                btn.onclick = () => window.applyTheme(p.colors);
                btn.innerHTML = `<div class="grid grid-cols-2 gap-0.5">${p.colors.map(c => `<div class="w-1.5 h-1.5 rounded-full" style="background:${c}"></div>`).join('')}</div><span>${p.name}</span>`;
                themeContainer.appendChild(btn);
            });

            fortuneSamples.forEach(s => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-800 p-2 rounded border border-slate-700 hover:border-indigo-500 transition text-[10px] text-indigo-200 font-bold";
                btn.innerText = s.name;
                btn.onclick = () => window.applyFortuneSample(s.list);
                sampleContainer.appendChild(btn);
            });

            for (let i = 0; i < 8; i++) {
                const row = document.createElement('div');
                row.className = "flex items-center gap-2";
                row.innerHTML = `<span class="text-[10px] text-slate-500 w-4">${i+1}</span>
                    <input type="text" id="fortune-input-${i}" class="flex-grow bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs focus:border-indigo-500 outline-none" placeholder="Fortune ${i+1}">`;
                inputContainer.appendChild(row);
            }

            games.forEach((game, index) => {
                const tab = document.createElement('div');
                tab.id = `tab-${game.id}`;
                tab.className = `nav-btn ${index === 0 ? 'active' : ''}`;
                tab.innerText = game.title;
                tab.onclick = () => window.switchTab(game.id);
                tabsContainer.appendChild(tab);

                const section = document.createElement('div');
                section.id = `section-${game.id}`;
                section.className = `game-container ${index === 0 ? '' : 'hidden'}`;
                
                if (game.type === 'iframe') {
                    const ifr = document.createElement('iframe');
                    ifr.src = game.url;
                    section.appendChild(ifr);
                } else if (game.id === 'cootie') {
                    const temp = document.getElementById('cootie-template');
                    section.appendChild(temp.content.cloneNode(true));
                }
                viewport.appendChild(section);
            });
            window.switchTab(games[0].id);
        }

        window.switchTab = function(gameId) {
            games.forEach(g => {
                document.getElementById(`section-${g.id}`).classList.toggle('hidden', g.id !== gameId);
                document.getElementById(`tab-${g.id}`).classList.toggle('active', g.id === gameId);
            });
            if (gameId === 'cootie') window.initColors();
        }

        window.toggleCustomize = function(show) {
            document.getElementById('customize-modal').style.display = show ? 'flex' : 'none';
            if (show) {
                document.getElementById('color-tl').value = activeTheme[0];
                document.getElementById('color-tr').value = activeTheme[1];
                document.getElementById('color-bl').value = activeTheme[2];
                document.getElementById('color-br').value = activeTheme[3];
                for (let i = 0; i < 8; i++) {
                    document.getElementById(`fortune-input-${i}`).value = activeFortunes[i];
                }
            }
        }

        window.applyTheme = function(colors) {
            activeTheme = [...colors];
            document.getElementById('color-tl').value = colors[0];
            document.getElementById('color-tr').value = colors[1];
            document.getElementById('color-bl').value = colors[2];
            document.getElementById('color-br').value = colors[3];
        }

        window.applyFortuneSample = function(list) {
            activeFortunes = [...list];
            for (let i = 0; i < 8; i++) {
                document.getElementById(`fortune-input-${i}`).value = activeFortunes[i];
            }
        }

        window.saveSettingsToCloud = async function() {
            activeTheme = [
                document.getElementById('color-tl').value,
                document.getElementById('color-tr').value,
                document.getElementById('color-bl').value,
                document.getElementById('color-br').value
            ];
            activeFortunes = [];
            for (let i = 0; i < 8; i++) {
                activeFortunes.push(document.getElementById(`fortune-input-${i}`).value || `Fortune ${i+1}`);
            }

            if (isLocalMode || !user) {
                window.initColors();
                window.toggleCustomize(false);
                return;
            }

            const saveBtn = document.getElementById('save-btn');
            saveBtn.innerText = "Saving...";
            saveBtn.disabled = true;

            try {
                const settingsDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'cootie');
                await setDoc(settingsDoc, { theme: activeTheme, fortunes: activeFortunes, updatedAt: Date.now() });
                window.initColors();
                window.toggleCustomize(false);
            } catch (err) {
                console.error("Save error:", err);
            } finally {
                saveBtn.innerText = "Save Everything âœ¨";
                saveBtn.disabled = false;
            }
        }

        // --- Game Logic ---
        let gameState = 'COLORS';
        let isAnimating = false;
        let selections = { color: '', num1: null, num2: null };
        let currentFortune = '';

        window.initColors = function() {
            const section = document.getElementById('section-cootie');
            if (!section) return;
            gameState = 'COLORS';
            section.querySelector('#instruction').innerText = "Pick a Color!";
            section.querySelector('#counter').innerText = "";
            selections = { color: '', num1: null, num2: null };
            const labels = ['RED', 'BLUE', 'GREEN', 'YELLOW'];
            ['tl', 'tr', 'bl', 'br'].forEach((id, i) => {
                const el = section.querySelector(`#content-${id}`);
                el.innerText = labels[i];
                el.parentElement.style.backgroundColor = activeTheme[i];
                el.style.color = 'white';
            });
        }

        window.handleChoice = async function(idSuffix) {
            if (isAnimating || gameState === 'REVEAL') return;
            const section = document.getElementById('section-cootie');
            const choice = section.querySelector('#content-' + idSuffix).innerText;
            if (gameState === 'COLORS') {
                selections.color = choice;
                await window.animateCatcher(choice.length);
                gameState = 'NUMBER_1';
                section.querySelector('#instruction').innerText = "Pick a Number!";
                window.showNumbers(1);
            } else if (gameState === 'NUMBER_1') {
                selections.num1 = choice;
                await window.animateCatcher(parseInt(choice));
                gameState = 'NUMBER_2';
                section.querySelector('#instruction').innerText = "Pick one last Number!";
                window.showNumbers(2);
            } else if (gameState === 'NUMBER_2') {
                selections.num2 = choice;
                window.revealFortune();
            }
        }

        window.showNumbers = function(set) {
            const nums = set === 1 ? [1, 2, 5, 6] : [3, 4, 7, 8];
            const section = document.getElementById('section-cootie');
            ['tl', 'tr', 'bl', 'br'].forEach((id, i) => {
                const el = section.querySelector(`#content-${id}`);
                el.innerText = nums[i];
                el.style.color = '#a5b4fc';
                el.parentElement.style.backgroundColor = '#1e293b';
            });
        }

        window.animateCatcher = async function(count) {
            isAnimating = true;
            const section = document.getElementById('section-cootie');
            const cat = section.querySelector('#catcher');
            const countEl = section.querySelector('#counter');
            for (let i = 0; i < count; i++) {
                countEl.innerText = i + 1;
                cat.className = (i % 2 === 0) ? 'catcher open-v' : 'catcher open-h';
                await new Promise(r => setTimeout(r, 400));
                cat.className = 'catcher';
                await new Promise(r => setTimeout(r, 100));
            }
            countEl.innerText =
