<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trons Games</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Handlee&display=swap');

        body {
            font-family: 'Handlee', cursive;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        nav {
            background-color: #1e293b;
            border-bottom: 2px solid #334155;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            flex-shrink: 0;
            height: 50px;
        }

        .nav-btn {
            padding: 0.3rem 0.7rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            font-size: 0.8rem;
        }

        .nav-btn.active {
            background-color: #4f46e5;
            color: white;
        }

        .nav-btn:not(.active):hover {
            background-color: #334155;
        }

        .game-viewport {
            flex-grow: 1;
            position: relative;
            display: flex;
            width: 100%;
            height: calc(100vh - 50px);
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; 
            padding: 0.75rem;
            overflow-y: auto;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .scene { 
            perspective: 1000px; 
            width: 180px; 
            height: 180px; 
            position: relative;
            flex-shrink: 0;
            margin: 0.5rem 0;
        }
        .catcher { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.5s ease; }
        .flap {
            position: absolute; width: 90px; height: 90px; background: #1e293b; border: 2px solid #334155;
            transform-origin: center; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), background 0.3s;
            user-select: none; box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
        }
        .top-left { top: 0; left: 0; border-radius: 10px 0 0 0; }
        .top-right { top: 0; left: 90px; border-radius: 0 10px 0 0; }
        .bottom-left { top: 90px; left: 0; border-radius: 0 0 0 10px; }
        .bottom-right { top: 90px; left: 90px; border-radius: 0 0 10px 0; }
        
        .catcher.open-h .top-left { transform: rotateY(-40deg) translateX(-10px); }
        .catcher.open-h .top-right { transform: rotateY(40deg) translateX(10px); }
        .catcher.open-h .bottom-left { transform: rotateY(-40deg) translateX(-10px); }
        .catcher.open-h .bottom-right { transform: rotateY(40deg) translateX(10px); }
        .catcher.open-v .top-left { transform: rotateX(40deg) translateY(-10px); }
        .catcher.open-v .top-right { transform: rotateX(40deg) translateY(-10px); }
        .catcher.open-v .bottom-left { transform: rotateX(-40deg) translateY(10px); }
        .catcher.open-v .bottom-right { transform: rotateX(-40deg) translateY(10px); }

        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(6px); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #1e293b; padding: 1.25rem; border-radius: 1.5rem; max-width: 95%;
            width: 450px; border: 2px solid #334155; max-height: 90vh; overflow-y: auto;
        }

        .hidden-fortune {
            background: #1e293b; padding: 1.25rem; border-radius: 1.5rem; 
            max-width: 90%; width: 310px; border: 4px dashed #818cf8; text-align: center;
            box-shadow: 0 0 80px rgba(0,0,0,1);
        }
        .dot-pulse { animation: dotPulse 1.5s infinite linear; }
        @keyframes dotPulse { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }
        
        .save-indicator {
            position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%);
            background: #22c55e; color: white; padding: 0.4rem 1rem; border-radius: 99px;
            font-size: 0.7rem; font-weight: bold; opacity: 0; transition: opacity 0.3s;
            z-index: 3000; pointer-events: none;
        }
    </style>
</head>
<body>

    <nav>
        <div class="flex items-center gap-2">
            <span class="text-base font-bold text-indigo-400 mr-2 hidden sm:inline">Trons Games</span>
            <div id="nav-tabs" class="flex gap-1"></div>
        </div>
        <div id="status-tag" class="text-[9px] text-slate-500 bg-slate-800 px-2 py-0.5 rounded uppercase font-bold tracking-tighter">Secure Local</div>
    </nav>

    <div id="game-viewport" class="game-viewport"></div>

    <div id="save-msg" class="save-indicator">Saved Locally! âœ¨</div>

    <!-- Customization Modal -->
    <div id="customize-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-lg font-bold text-indigo-400 mb-3">Game Settings</h2>
            
            <div class="mb-4">
                <label class="block text-[10px] font-bold uppercase text-slate-500 mb-1 tracking-widest">Gemini API Key (Hidden)</label>
                <p class="text-[9px] text-slate-400 mb-2">Required for AI Mode on GitHub. Get yours at <a href="https://aistudio.google.com/" target="_blank" class="text-indigo-400 underline">Google AI Studio</a>.</p>
                <input type="password" id="custom-api-key" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-xs text-indigo-400 focus:border-indigo-500 outline-none mb-3" placeholder="Paste your API key here">

                <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2 tracking-widest">Fortune Samples</label>
                <div id="fortune-presets" class="grid grid-cols-2 gap-2 mb-3"></div>
                
                <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1 tracking-widest">Edit Results (8 Slots)</label>
                <div id="fortune-inputs" class="grid grid-cols-1 gap-1.5 max-h-36 overflow-y-auto pr-2 mb-3 border-y border-slate-700 py-2"></div>
            </div>

            <div class="mb-5">
                <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2 tracking-widest">Theme Colors</label>
                <div id="theme-presets" class="grid grid-cols-3 gap-2 mb-3"></div>
                <div class="grid grid-cols-4 gap-2">
                    <input type="color" id="color-tl" class="w-full h-7 rounded bg-slate-800 border-none cursor-pointer">
                    <input type="color" id="color-tr" class="w-full h-7 rounded bg-slate-800 border-none cursor-pointer">
                    <input type="color" id="color-bl" class="w-full h-7 rounded bg-slate-800 border-none cursor-pointer">
                    <input type="color" id="color-br" class="w-full h-7 rounded bg-slate-800 border-none cursor-pointer">
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="saveAllSettings()" class="flex-grow bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition text-xs">Save Everything âœ¨</button>
                <button onclick="toggleCustomize(false)" class="bg-slate-700 hover:bg-slate-600 text-slate-200 py-2 px-4 rounded-lg transition text-xs">Cancel</button>
            </div>
        </div>
    </div>

    <template id="cootie-template">
        <div class="game-container">
            <div class="text-center pt-1">
                <h1 class="text-lg font-bold text-indigo-400 leading-tight">Cootie Catcher</h1>
                <p id="instruction" class="text-[10px] text-indigo-300 font-medium h-3">Pick a Color!</p>
            </div>
            
            <div class="scene">
                <div id="catcher" class="catcher">
                    <div class="flap top-left" onclick="handleChoice('tl')"><div id="content-tl" class="w-full h-full flex items-center justify-center font-bold text-[10px] text-center p-1 uppercase"></div></div>
                    <div class="flap top-right" onclick="handleChoice('tr')"><div id="content-tr" class="w-full h-full flex items-center justify-center font-bold text-[10px] text-center p-1 uppercase"></div></div>
                    <div class="flap bottom-left" onclick="handleChoice('bl')"><div id="content-bl" class="w-full h-full flex items-center justify-center font-bold text-[10px] text-center p-1 uppercase"></div></div>
                    <div class="flap bottom-right" onclick="handleChoice('br')"><div id="content-br" class="w-full h-full flex items-center justify-center font-bold text-[10px] text-center p-1 uppercase"></div></div>
                </div>
            </div>

            <div id="fortune-overlay" class="modal-overlay" onclick="resetGame()">
                <div id="fortune-modal" class="hidden-fortune" onclick="event.stopPropagation()">
                    <h2 class="text-base font-bold text-indigo-300 mb-1">Result:</h2>
                    <div id="loading-spinner" class="mb-2 hidden">
                        <div class="flex justify-center gap-1.5">
                            <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full dot-pulse"></div>
                            <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full dot-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full dot-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                    <p id="fortune-text" class="text-sm italic text-slate-100 mb-3 leading-relaxed px-2"></p>
                    <div id="charm-container" class="hidden mb-3 flex flex-col items-center">
                        <img id="charm-image" class="w-16 h-16 rounded-lg shadow-xl border-2 border-indigo-500/30 mb-2" src="" alt="Charm">
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <div class="flex gap-1.5">
                            <button id="tts-btn" onclick="speakFortune()" class="flex-1 bg-indigo-900/50 text-indigo-200 border border-indigo-500/50 px-2 py-1.5 rounded-full text-[9px] hidden font-bold">Hear âœ¨</button>
                            <button id="image-btn" onclick="generateCharm()" class="flex-1 bg-indigo-900/50 text-indigo-200 border border-indigo-500/50 px-2 py-1.5 rounded-full text-[9px] hidden font-bold">Charm âœ¨</button>
                        </div>
                        <button onclick="resetGame()" class="w-full bg-indigo-600 text-white px-4 py-1.5 rounded-full hover:bg-indigo-500 transition text-xs font-bold shadow-lg">Play Again</button>
                    </div>
                </div>
            </div>

            <div class="h-5 flex items-center justify-center">
                <div id="counter" class="text-lg font-bold text-indigo-400"></div>
            </div>
            
            <div class="flex flex-col gap-1 w-full max-w-[220px] mb-4">
                <button onclick="toggleCustomize(true)" class="bg-indigo-900/40 text-indigo-200 border border-indigo-500/30 px-3 py-1.5 rounded-full hover:bg-indigo-800 transition text-[10px] font-bold">
                    Customize Results & Theme ðŸŽ¨
                </button>
                <div class="flex items-center justify-between bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                    <span class="text-indigo-300 font-medium text-[9px] uppercase tracking-wider">AI Magic Mode</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="gemini-toggle" class="sr-only peer" checked>
                        <div class="w-6 h-3.5 bg-slate-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-indigo-500"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                    <span class="text-indigo-300 font-medium text-[9px] uppercase tracking-wider">AI Style âœ¨</span>
                    <select id="fortune-vibe" class="bg-transparent text-indigo-200 text-[9px] focus:outline-none font-bold">
                        <option value="heroic">Heroic</option>
                        <option value="spooky">Spooky</option>
                        <option value="funny">Funny</option>
                        <option value="mystical" selected>Mystical</option>
                    </select>
                </div>
            </div>
        </div>
    </template>

    <script>
        const STORAGE_KEY = 'trons_games_v3';
        const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const IMAGE_MODEL = "imagen-4.0-generate-001";
        
        // MANDATORY: KEY MUST BE EMPTY STRING
        const apiKey = ""; 
        let customApiKeyEncoded = "";

        const themePresets = [
            { id: 'classic', name: 'Classic', colors: ['#991b1b', '#1e3a8a', '#064e3b', '#713f12'] },
            { id: 'cyber', name: 'Cyber', colors: ['#ec4899', '#06b6d4', '#84cc16', '#a855f7'] },
            { id: 'sunset', name: 'Sunset', colors: ['#ea580c', '#be123c', '#ca8a04', '#7e22ce'] }
        ];

        const fortuneSamples = [
            { name: 'Standard', list: ["Lucky penny day!", "Adventure awaits!", "New friend soon!", "Surprise coming!", "Kindness rewarded!", "Secret admirer!", "Success ahead!", "Famous explorer!"] },
            { name: 'Jokes', list: ["Math book sad? Too many problems.", "Plate to plate? Dinner is on me!", "Tissue dance? Boogey!", "Cat color? Purrr-ple.", "Pencil vacation? Pencil-vania.", "Trust atoms? They make up everything.", "Falls but never hurt? Snow.", "Teacher shades? Bright students!"] }
        ];

        let activeTheme = [...themePresets[0].colors];
        let activeFortunes = [...fortuneSamples[0].list];

        const games = [
            { id: 'wordle', title: 'Wordle', type: 'iframe', url: 'https://tronsguitar.github.io/Wordle-Clone/' },
            { id: 'cootie', title: 'Cootie Catcher', type: 'internal' }
        ];

        function getActiveKey() {
            // Priority: Runtime Injection -> Encoded Local Storage
            if (apiKey && apiKey !== "") return apiKey;
            try {
                return customApiKeyEncoded ? atob(customApiKeyEncoded) : "";
            } catch (e) { return ""; }
        }

        function loadSettings() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                activeTheme = data.theme || activeTheme;
                activeFortunes = data.fortunes || activeFortunes;
                customApiKeyEncoded = data.k || "";
            }
        }

        function saveAllSettings() {
            activeTheme = [
                document.getElementById('color-tl').value,
                document.getElementById('color-tr').value,
                document.getElementById('color-bl').value,
                document.getElementById('color-br').value
            ];
            activeFortunes = [];
            for (let i = 0; i < 8; i++) {
                activeFortunes.push(document.getElementById(`fortune-input-${i}`).value || `Result ${i+1}`);
            }
            const rawKey = document.getElementById('custom-api-key').value;
            customApiKeyEncoded = rawKey ? btoa(rawKey) : "";

            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                theme: activeTheme,
                fortunes: activeFortunes,
                k: customApiKeyEncoded
            }));

            const toast = document.getElementById('save-msg');
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2000);

            window.initColors();
            window.toggleCustomize(false);
        }

        window.setupApp = function() {
            loadSettings();
            const tabsContainer = document.getElementById('nav-tabs');
            const viewport = document.getElementById('game-viewport');
            const themeContainer = document.getElementById('theme-presets');
            const sampleContainer = document.getElementById('fortune-presets');
            const inputContainer = document.getElementById('fortune-inputs');

            themePresets.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "flex flex-col items-center gap-1 bg-slate-800 p-1.5 rounded border border-slate-700 hover:border-indigo-500 transition text-[9px]";
                btn.onclick = () => window.applyTheme(p.colors);
                btn.innerHTML = `<div class="grid grid-cols-2 gap-0.5">${p.colors.map(c => `<div class="w-1.5 h-1.5 rounded-full" style="background:${c}"></div>`).join('')}</div><span>${p.name}</span>`;
                themeContainer.appendChild(btn);
            });

            fortuneSamples.forEach(s => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-800 p-1.5 rounded border border-slate-700 hover:border-indigo-500 transition text-[9px] text-indigo-200 font-bold";
                btn.innerText = s.name;
                btn.onclick = () => window.applyFortuneSample(s.list);
                sampleContainer.appendChild(btn);
            });

            for (let i = 0; i < 8; i++) {
                const row = document.createElement('div');
                row.className = "flex items-center gap-2";
                row.innerHTML = `<span class="text-[9px] text-slate-500 w-3">${i+1}</span>
                    <input type="text" id="fortune-input-${i}" class="flex-grow bg-slate-900 border border-slate-700 rounded px-2 py-1 text-[10px] focus:border-indigo-500 outline-none">`;
                inputContainer.appendChild(row);
            }

            games.forEach((game, index) => {
                const tab = document.createElement('div');
                tab.id = `tab-${game.id}`;
                tab.className = `nav-btn ${index === 0 ? 'active' : ''}`;
                tab.innerText = game.title;
                tab.onclick = () => window.switchTab(game.id);
                tabsContainer.appendChild(tab);

                const section = document.createElement('div');
                section.id = `section-${game.id}`;
                section.className = `w-full h-full ${index === 0 ? '' : 'hidden'}`;
                
                if (game.type === 'iframe') {
                    const ifr = document.createElement('iframe');
                    ifr.src = game.url;
                    section.appendChild(ifr);
                } else if (game.id === 'cootie') {
                    const temp = document.getElementById('cootie-template');
                    section.appendChild(temp.content.cloneNode(true));
                }
                viewport.appendChild(section);
            });
            window.switchTab(games[0].id);
        }

        window.switchTab = function(gameId) {
            games.forEach(g => {
                const s = document.getElementById(`section-${g.id}`);
                const t = document.getElementById(`tab-${g.id}`);
                if (s) s.classList.toggle('hidden', g.id !== gameId);
                if (t) t.classList.toggle('active', g.id === gameId);
            });
            if (gameId === 'cootie') window.initColors();
        }

        window.toggleCustomize = function(show) {
            document.getElementById('customize-modal').style.display = show ? 'flex' : 'none';
            if (show) {
                try {
                    document.getElementById('custom-api-key').value = customApiKeyEncoded ? atob(customApiKeyEncoded) : "";
                } catch(e) {}
                document.getElementById('color-tl').value = activeTheme[0];
                document.getElementById('color-tr').value = activeTheme[1];
                document.getElementById('color-bl').value = activeTheme[2];
                document.getElementById('color-br').value = activeTheme[3];
                for (let i = 0; i < 8; i++) {
                    document.getElementById(`fortune-input-${i}`).value = activeFortunes[i] || "";
                }
            }
        }

        window.applyTheme = function(colors) {
            document.getElementById('color-tl').value = colors[0];
            document.getElementById('color-tr').value = colors[1];
            document.getElementById('color-bl').value = colors[2];
            document.getElementById('color-br').value = colors[3];
        }

        window.applyFortuneSample = function(list) {
            for (let i = 0; i < 8; i++) {
                document.getElementById(`fortune-input-${i}`).value = list[i];
            }
        }

        let gameState = 'COLORS';
        let isAnimating = false;
        let selections = { color: '', num1: null, num2: null };
        let currentFortune = '';

        window.initColors = function() {
            const section = document.getElementById('section-cootie');
            if (!section) return;
            gameState = 'COLORS';
            section.querySelector('#instruction').innerText = "Pick a Color!";
            section.querySelector('#counter').innerText = "";
            selections = { color: '', num1: null, num2: null };
            const labels = ['RED', 'BLUE', 'GREEN', 'YELLOW'];
            ['tl', 'tr', 'bl', 'br'].forEach((id, i) => {
                const el = section.querySelector(`#content-${id}`);
                if (el) {
                    el.innerText = labels[i];
                    el.parentElement.style.backgroundColor = activeTheme[i];
                    el.style.color = 'white';
                }
            });
        }

        window.handleChoice = async function(idSuffix) {
            if (isAnimating || gameState === 'REVEAL') return;
            const section = document.getElementById('section-cootie');
            const choice = section.querySelector('#content-' + idSuffix).innerText;
            if (gameState === 'COLORS') {
                selections.color = choice;
                await window.animateCatcher(choice.length);
                gameState = 'NUMBER_1';
                section.querySelector('#instruction').innerText = "Pick a Number!";
                window.showNumbers(1);
            } else if (gameState === 'NUMBER_1') {
                selections.num1 = choice;
                await window.animateCatcher(parseInt(choice) || 1);
                gameState = 'NUMBER_2';
                section.querySelector('#instruction').innerText = "Pick the last Number!";
                window.showNumbers(2);
            } else if (gameState === 'NUMBER_2') {
                selections.num2 = choice;
                window.revealFortune();
            }
        }

        window.showNumbers = function(set) {
            const nums = set === 1 ? [1, 2, 5, 6] : [3, 4, 7, 8];
            const section = document.getElementById('section-cootie');
            ['tl', 'tr', 'bl', 'br'].forEach((id, i) => {
                const el = section.querySelector(`#content-${id}`);
                if (el) {
                    el.innerText = nums[i];
                    el.style.color = '#a5b4fc';
                    el.parentElement.style.backgroundColor = '#1e293b';
                }
            });
        }

        window.animateCatcher = async function(count) {
            isAnimating = true;
            const section = document.getElementById('section-cootie');
            const cat = section.querySelector('#catcher');
            const countEl = section.querySelector('#counter');
            for (let i = 0; i < count; i++) {
                countEl.innerText = i + 1;
                cat.className = (i % 2 === 0) ? 'catcher open-v' : 'catcher open-h';
                await new Promise(r => setTimeout(r, 400));
                cat.className = 'catcher';
                await new Promise(r => setTimeout(r, 100));
            }
            countEl.innerText = "";
            isAnimating = false;
        }

        window.revealFortune = async function() {
            gameState = 'REVEAL';
            const section = document.getElementById('section-cootie');
            section.querySelector('#instruction').innerText = "Revealed!";
            section.querySelector('#fortune-overlay').style.display = 'flex';
            const fText = section.querySelector('#fortune-text');
            fText.innerText = "";
            
            section.querySelector('#charm-container').classList.add('hidden');
            section.querySelector('#tts-btn').classList.add('hidden');
            section.querySelector('#image-btn').classList.add('hidden');

            const activeKey = getActiveKey();
            if (section.querySelector('#gemini-toggle').checked && activeKey) {
                section.querySelector('#loading-spinner').classList.remove('hidden');
                const vibe = section.querySelector('#fortune-vibe').value;
                currentFortune = await window.callGemini(vibe, activeKey);
                section.querySelector('#loading-spinner').classList.add('hidden');
                fText.innerText = currentFortune;
                section.querySelector('#tts-btn').classList.remove('hidden');
                section.querySelector('#image-btn').classList.remove('hidden');
            } else {
                currentFortune = activeFortunes[Math.floor(Math.random() * activeFortunes.length)];
                fText.innerText = currentFortune;
            }
        }

        window.callGemini = async function(vibe, activeKey) {
            const systemPrompt = `Whimsical magic teller. One short whimsical sentence. Style: ${vibe}. No markdown.`;
            const userQuery = `Choices: Color ${selections.color}, Nums ${selections.num1}, ${selections.num2}. Context: Some static fortunes are ${activeFortunes.slice(0,3).join(", ")}.`;
            const fetchFn = () => fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${activeKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ parts: [{ text: userQuery }] }], 
                    systemInstruction: { parts: [{ text: systemPrompt }] } 
                })
            });
            const result = await retryRequest(fetchFn);
            return result?.candidates?.[0]?.content?.parts?.[0]?.text || "Joy is coming!";
        }

        async function retryRequest(fn, retries = 5) {
            for (let i = 0; i <= retries; i++) {
                try {
                    const res = await fn();
                    if (!res.ok) throw new Error();
                    return await res.json();
                } catch (e) {
                    if (i === retries) return null;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        window.speakFortune = async function() {
            const section = document.getElementById('section-cootie');
            const btn = section.querySelector('#tts-btn');
            const activeKey = getActiveKey();
            btn.disabled = true; btn.innerText = "...";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${activeKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say magically: ${currentFortune}` }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"], 
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } } 
                        }
                    })
                });
                const result = await response.json();
                window.playAudio(result.candidates[0].content.parts[0].inlineData.data);
            } catch (e) {} finally {
                btn.disabled = false; btn.innerText = "Hear âœ¨";
            }
        }

        window.generateCharm = async function() {
            const section = document.getElementById('section-cootie');
            const btn = section.querySelector('#image-btn');
            const activeKey = getActiveKey();
            btn.innerText = "..."; btn.disabled = true;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:predict?key=${activeKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        instances: { prompt: `Magic charm: ${currentFortune}. 3D glowing sticker icon.` }, 
                        parameters: { sampleCount: 1 } 
                    })
                });
                const result = await response.json();
                section.querySelector('#charm-image').src = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                section.querySelector('#charm-container').classList.remove('hidden');
                btn.classList.add('hidden');
            } catch (e) {} finally {
                btn.disabled = false; btn.innerText = "Charm âœ¨";
            }
        }

        window.playAudio = function(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);
            const blob = new Blob([bytes], {type:'audio/wav'});
            new Audio(URL.createObjectURL(blob)).play();
        }

        window.resetGame = function() {
            const section = document.getElementById('section-cootie');
            const overlay = section.querySelector('#fortune-overlay');
            if (overlay) overlay.style.display = 'none';
            section.querySelector('#catcher').className = 'catcher';
            window.initColors();
        }

        window.onload = window.setupApp;
    </script>
</body>
</html>
